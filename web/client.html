<!DOCTYPE html>
	<html>
	<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>Storm t4fsq</title>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <script type='text/javascript' src='http://code.jquery.com/jquery-1.9.1.js'></script>
    <script type="text/javascript" src="world.js"></script>
	<script type="text/javascript" src="canvas.js"></script>
	<script type="text/javascript" src="colorScale.js"></script>

    <script type="text/javascript" src="raphael-min.js"></script>
    <style media="screen">
            #latlon-form {
                position: absolute;
                top: 430px;
            }
            #latlon-form input {
                font-size: 14px;
                width: 200px;
            }
            #latlon-form button {
                font-size: 14px;
            }
            #cities {
                position: absolute;
                top: 470px;
                margin: 0 10px;
                padding: 0;
                list-style: none;
            }
            #cities a {
                color: #ccf;
            }
        </style>
<script>
	

function drawWorld(){
	//paper = Raphael(10, 10, 1000, 400);
	// paper.rect(0, 0, 1000, 400, 10).attr({stroke: "none",fill: "0-#9bb7cb-#adc8da"});
	// for (var country in worldmap.shapes) {
	// 	paper.path(worldmap.shapes[country]).attr({stroke: "#ccc6ae", fill: "#ffffff", "stroke-opacity": 1});
 //    }
			
				
}

</script>
	</head>
	<body onload="drawWorld()">


		<script src="http://127.0.0.1:3000/socket.io/socket.io.js"> </script>

		<script>

         
		 
		var pointsArray = [];
	
		var socket = io.connect("http://localhost:3000");

		socket.on('connect', function(){

        	console.log('connected');
        
   		 });




   		 socket.on('nation', function(data){ 
        
       		console.log('message received: ' + data);
       		
        		document.getElementById('resultField').value = data;
    	});

       socket.on('coords',function(data){
          //var dataJson = JSON.parse(data);
          console.log(data);
         
                var r = paper;
                var over = function () {
                    this.c = this.c || this.attr("fill");
                    this.stop().animate({fill: "#bacabd"}, 500);
                },
                    out = function () {
                        this.stop().animate({fill: this.c}, 500);
                    };
                r.setStart();
                
                var world = r.setFinish();
                world.hover(over, out);
                world.getXY = function (lat, lon) {
                    return {
                        cx: lon * 2.6938 + 465.4,
                        cy: lat * -2.6938 + 227.066
                    };
                };
                world.getLatLon = function (x, y) {
                    return {
                        lat: (y - 227.066) / -2.6938,
                        lon: (x - 465.4) / 2.6938
                    };
                };
                var latlonrg = /(\d+(?:\.\d+)?)[\xb0\s]?\s*(?:(\d+(?:\.\d+)?)['\u2019\u2032\s])?\s*(?:(\d+(?:\.\d+)?)["\u201d\u2033\s])?\s*([SNEW])?/i;
        
                world.parseLatLon = function (latlon) {
                    var m = String(latlon).split(latlonrg),
                        lat = m && +m[1] + (m[2] || 0) / 60 + (m[3] || 0) / 3600;
                    if (m[4].toUpperCase() == "S") {
                        lat = -lat;
                    }
                    var lon = m && +m[6] + (m[7] || 0) / 60 + (m[8] || 0) / 3600;
                    if (m[9].toUpperCase() == "W") {
                        lon = -lon;
                    }
          
                    return this.getXY(lat, lon);
                };
                    
					var ll = data["ll"];
					var acr = data["acr"];
					
				
									
					
					
					var country = worldmap["shapes"][acr];
					var newPath =	r.path(country)
					console.log(acr);
					var colore = color["colors"][acr];
					 
				    var colorSommato = hex2Int(colore);
					color["colors"][acr] = colorSommato;
					console.log(colorSommato)
					newPath.stop().animate({fill: colorSommato,stroke: "none"});
					
				    var llDot = world.parseLatLon(ll);
					
                    if(pointsArray.length === 0){
					var dot = r.circle().attr({fill: "r#FE7727:50-#F57124:100", stroke: "#fff", "stroke-width": 2});
					
                    //Disegnamo i punti
					dot.stop().attr(llDot).animate({r: 2}, 1000, "elastic");
                    //llDot.r = 0;
					
					}
					
					
					for(var cont=0;cont<pointsArray.length;cont++){
					
					var dot = r.circle().attr({fill: "r#FE7727:50-#F57124:100", stroke: "#fff", "stroke-width": 2});
					dot.stop().attr(pointsArray[cont]).animate({r: 2}, 1000, "elastic");
					
					}
                    
					pointsArray.push(llDot);
					console.log(pointsArray.length)

                
            
  
       });
   		

    	socket.on('disconnect', function(){
    	
        	console.log('disconected');

    	});
    
		function startStorm(){

			var data = document.getElementById('category').value;
            var jsonData = {'cat': data};

			socket.emit('startStorm',jsonData);

    }

</script>
<input type="text" id="category" style="margin-top: 46px; margin-left: 5px"><button id="start" onclick="startStorm()" style="margin-left: 30px; margin-top: 50px">Start</button></input>

	</body>
	</html>					